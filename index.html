<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±ä¼šè©±ç·´ç¿’ï¼ˆEdgeç‰ˆ / ç„¡æ–™MVPï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Meiryo,Arial,sans-serif;margin:20px;line-height:1.6}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    select,button,input{font-size:16px;padding:8px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin-top:12px}
    .good{background:#e6ffed;padding:2px 6px;border-radius:6px}
    .bad{background:#ffecec;padding:2px 6px;border-radius:6px}
    .small{opacity:.8;font-size:13px}
  </style>
</head>
<body>
  <h1>è‹±ä¼šè©±ç·´ç¿’ï¼ˆEdgeç‰ˆ / ç„¡æ–™MVPï¼‰</h1>

  <div class="card">
    <div class="row">
      <label>ãƒ¬ãƒ™ãƒ«ï¼š</label>
      <select id="level">
        <option value="L0">L0 å®Œå…¨åˆå¿ƒè€…ï¼ˆTOEIC&lt;300ï¼‰</option>
        <option value="L1">L1 åˆå¿ƒè€…ï¼ˆ300-500ï¼‰</option>
        <option value="L2">L2 åˆä¸­ç´šï¼ˆ500-650ï¼‰</option>
        <option value="L3">L3 ä¸­ç´šï¼ˆ650+ï¼‰</option>
      </select>

      <label>ã‚·ãƒ¼ãƒ³ï¼š</label>
      <select id="scene"></select>

      <button id="tts">ãŠæ‰‹æœ¬ã‚’èã</button>
      <button id="rec">ğŸ™ï¸ éŒ²éŸ³ã—ã¦åˆ¤å®š</button>
    </div>

    <p id="target" style="font-weight:700;margin-top:10px"></p>
    <div class="small">â€» ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆEdgeã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ğŸ”’ã‹ã‚‰è¨±å¯ï¼‰</div>
  </div>

  <div class="card">
    <h3>çµæœï¼ˆå·®åˆ†ï¼‰</h3>
    <div id="diff"></div>
    <h3>æ—¥æœ¬èªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆæ—¥æœ¬äººã®å¼±ç‚¹ï¼‰</h3>
    <ul id="tips"></ul>
  </div>

  <div class="card">
    <h3>å­¦ç¿’ãƒ­ã‚°ï¼ˆlocalStorageï¼‰</h3>
    <div id="log"></div>
    <button id="reset">ãƒ­ã‚°ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

<script>
const scenes = [
  {id:"s1", lvl:["L0","L1"], title:"ã‚ã„ã•ã¤", target:"Hello. Nice to meet you."},
  {id:"s2", lvl:["L0","L1"], title:"è‡ªå·±ç´¹ä»‹", target:"I am from Japan."},
  {id:"s3", lvl:["L0","L1"], title:"é“ã‚’èã", target:"Where is the station?"},
  {id:"s4", lvl:["L1","L2"], title:"æ³¨æ–‡", target:"I'd like a coffee, please."},
  {id:"s5", lvl:["L2","L3"], title:"ä¼šè­°é–‹å§‹", target:"Let's get started with today's agenda."},
  {id:"s6", lvl:["L2","L3"], title:"ç´æœŸ", target:"Could you deliver it by next Friday?"},
  {id:"s7", lvl:["L1","L2"], title:"ãŠé¡˜ã„", target:"Could you help me with this?"},
  {id:"s8", lvl:["L0","L1"], title:"è²·ã„ç‰©", target:"How much is this?"},
  {id:"s9", lvl:["L1","L2"], title:"é›»è©±", target:"May I speak to Mr. Tanaka?"},
  {id:"s10",lvl:["L2","L3"], title:"æ„è¦‹", target:"In my opinion, this is the best option."},
];

const $ = (id)=>document.getElementById(id);
const levelSel=$("level"), sceneSel=$("scene"), targetEl=$("target");
const diffEl=$("diff"), tipsEl=$("tips"), logEl=$("log");

function tokenize(s){return s.toLowerCase().replace(/[^\w'\s]/g,"").split(/\s+/).filter(Boolean);}
function diffWords(target, said){
  const a=tokenize(target), b=tokenize(said);
  const setB=new Set(b);
  return a.map(w => setB.has(w) ? `<span class="good">${w}</span>` : `<span class="bad">${w}</span>`).join(" ");
}
function jpTips(target, said){
  const tips=[];
  const t=target.toLowerCase();
  const s=said.toLowerCase();
  // æ—¥æœ¬äººãŒè‹¦æ‰‹ã«ãªã‚Šã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆã‚’ã–ã£ãã‚Šæ¤œå‡º
  if (t.includes("th")) tips.push("THï¼šèˆŒå…ˆã‚’ä¸Šä¸‹ã®æ­¯ã®é–“ã«è»½ãå‡ºã—ã¦æ¯ã‚’å‡ºã—ã¾ã™ï¼ˆã‚µè¡Œã«ã—ãªã„ï¼‰ã€‚");
  if (t.match(/\br\b/) || t.match(/\bl\b/)) tips.push("L/Rï¼šèˆŒã®ä½ç½®ãŒé•ã„ã¾ã™ã€‚Lã¯èˆŒå…ˆã‚’ä¸Šå‰æ­¯ã®è£ã€Rã¯èˆŒã‚’å¥¥ã«ä¸¸ã‚æ°—å‘³ã§æµ®ã‹ã›ã¾ã™ã€‚");
  if (t.match(/\b(s|es)\b/) || t.match(/\b\w+s\b/)) tips.push("èªå°¾ã®å­éŸ³ï¼šèªå°¾ã®S/T/Kãªã©ã‚’è½ã¨ã—ã‚„ã™ã„ã®ã§ã€æ¯ã ã‘ã§ã‚‚å‡ºã—ã¦ç· ã‚ã¾ã™ã€‚");
  if (t.includes("nice to") || t.includes("get started") || t.includes("could you")) tips.push("ãƒªãƒ³ã‚­ãƒ³ã‚°ï¼šå˜èªã‚’åˆ‡ã‚‰ãšã«ã€ãƒŠã‚¤ã‚¹(ãƒˆã‚¥)ã€ã€ã‚¯ãƒƒã‚¸ãƒ¥ã€ã®ã‚ˆã†ã«ç¹‹ã’ã¾ã™ã€‚");
  if (t.match(/\b(a|an|the)\b/)) tips.push("å† è©ï¼ša/an/the ã‚’æŠœãã‚„ã™ã„ã®ã§ã€çŸ­ãã¦ã‚‚å¿…ãšå…¥ã‚Œã¾ã™ã€‚");
  if (!s || s.trim().length<2) tips.push("éŸ³å£°ãŒå–ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ï¼šãƒã‚¤ã‚¯è¨±å¯/å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹/é™ã‹ãªç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  return tips;
}

function loadScenes(){
  const lvl=levelSel.value;
  sceneSel.innerHTML="";
  scenes.filter(x=>x.lvl.includes(lvl)).forEach(x=>{
    const opt=document.createElement("option");
    opt.value=x.id; opt.textContent=x.title;
    sceneSel.appendChild(opt);
  });
  updateTarget();
}
function updateTarget(){
  const sc=scenes.find(x=>x.id===sceneSel.value) || scenes[0];
  targetEl.textContent="ç›®æ¨™æ–‡ï¼š " + sc.target;
  diffEl.innerHTML="";
  tipsEl.innerHTML="";
}
levelSel.addEventListener("change", loadScenes);
sceneSel.addEventListener("change", updateTarget);

function speak(text){
  const u=new SpeechSynthesisUtterance(text);
  u.lang="en-US";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

$("tts").addEventListener("click", ()=>{
  const sc=scenes.find(x=>x.id===sceneSel.value);
  speak(sc.target);
});

function logUpdate(ok){
  const key="eikaiwa_log_v1";
  const now=new Date();
  const today=now.toISOString().slice(0,10);
  const data=JSON.parse(localStorage.getItem(key) || '{"today":"","todayCount":0,"total":0,"streak":0,"lastDay":""}');
  if (data.today !== today){
    // streak
    if (data.lastDay){
      const last=new Date(data.lastDay);
      const d=(now-last)/(1000*60*60*24);
      data.streak = (d>0.9 && d<1.9) ? (data.streak+1) : 1;
    } else data.streak=1;
    data.today=today;
    data.todayCount=0;
    data.lastDay=today;
  }
  data.todayCount += 1;
  data.total += 1;
  localStorage.setItem(key, JSON.stringify(data));
  renderLog();
}

function renderLog(){
  const key="eikaiwa_log_v1";
  const data=JSON.parse(localStorage.getItem(key) || '{"today":"","todayCount":0,"total":0,"streak":0,"lastDay":""}');
  logEl.innerHTML = `
    <div>ä»Šæ—¥ï¼š${data.today} / å›æ•°ï¼š${data.todayCount}</div>
    <div>ç´¯è¨ˆï¼š${data.total}</div>
    <div>é€£ç¶šæ—¥æ•°ï¼š${data.streak}</div>
  `;
}
$("reset").addEventListener("click", ()=>{
  localStorage.removeItem("eikaiwa_log_v1");
  renderLog();
});

let rec;
$("rec").addEventListener("click", ()=>{
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆEdgeæœ€æ–°ç‰ˆã§è©¦ã—ã¦ãã ã•ã„ï¼‰");
    return;
  }
  const sc=scenes.find(x=>x.id===sceneSel.value);
  rec = new SpeechRecognition();
  rec.lang="en-US";
  rec.interimResults=false;
  rec.maxAlternatives=1;

  rec.onresult=(e)=>{
    const said=e.results[0][0].transcript;
    diffEl.innerHTML = `<div><b>ã‚ãªãŸï¼š</b> ${said}</div><div style="margin-top:8px">${diffWords(sc.target, said)}</div>`;
    const tips=jpTips(sc.target, said);
    tipsEl.innerHTML = tips.map(t=>`<li>${t}</li>`).join("");
    logUpdate(true);
  };
  rec.onerror=()=>{ tipsEl.innerHTML="<li>èªè­˜ã«å¤±æ•—ã€‚ãƒã‚¤ã‚¯è¨±å¯ã‚„å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</li>"; };
  rec.start();
});

loadScenes();
renderLog();
</script>
</body>
</html>
