<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è‹±ä¼šè©±ç·´ç¿’ï¼ˆEdgeç„¡æ–™MVPï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#111a2e; --panel2:#0f172a;
      --text:#e6edf7; --muted:#9bb0d0; --accent:#4cc9f0; --ok:#45d483; --ng:#ff6b6b;
      --chip:#1c2a4a; --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Meiryo,Arial;background:linear-gradient(180deg,#070b14,#0b1220 30%,#070b14);color:var(--text)}
    header{padding:18px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter: blur(10px);z-index:10}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-size:18px;font-weight:700}
    .badge{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      border:1px solid var(--border);border-radius:14px;padding:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text);cursor:pointer}
    .tab.active{border-color:rgba(76,201,240,.6);box-shadow:0 0 0 2px rgba(76,201,240,.15) inset}
    .muted{color:var(--muted);font-size:12px;line-height:1.6}
    select,button,input,textarea{
      background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--text);
      border-radius:10px;padding:10px;font-size:14px
    }
    button{cursor:pointer}
    button.primary{background:rgba(76,201,240,.12);border-color:rgba(76,201,240,.45)}
    button.ok{background:rgba(69,212,131,.12);border-color:rgba(69,212,131,.45)}
    button.ng{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.45)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .h2{font-size:15px;font-weight:700;margin:0 0 8px}
    .h3{font-size:13px;font-weight:700;margin:10px 0 6px}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:999px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:5px 9px;background:var(--chip);border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .k{padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02)}
    .k .v{font-size:18px;font-weight:800}
    .k .l{font-size:12px;color:var(--muted)}
    .qbox{padding:12px;border-radius:12px;background:rgba(255,255,255,.02);border:1px solid var(--border)}
    .choices{display:grid;gap:8px;margin-top:10px}
    .choice{padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02);cursor:pointer}
    .choice.correct{border-color:rgba(69,212,131,.6);background:rgba(69,212,131,.08)}
    .choice.wrong{border-color:rgba(255,107,107,.6);background:rgba(255,107,107,.08)}
    .small{font-size:12px}
    .hl-ok{background:rgba(69,212,131,.18);border-radius:6px;padding:2px 4px}
    .hl-ng{background:rgba(255,107,107,.18);border-radius:6px;padding:2px 4px}
    textarea{width:100%;min-height:140px;resize:vertical}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="title">è‹±ä¼šè©±ç·´ç¿’ï¼ˆEdgeç„¡æ–™MVPï¼‰</div>
    <span class="badge" id="ver">v2.1</span>
    <span class="badge">ç„¡æ–™ / ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°</span>
    <span class="badge">å­¦ç¿’ç®¡ç†ã¤ã</span>
    <span class="badge">ä¼šè©±=1æ–‡ãšã¤</span>
  </div>
  <div class="row" style="margin-top:10px">
    <div class="pill">
      ãƒ¬ãƒ™ãƒ«
      <select id="levelSel">
        <option value="A0">å®Œå…¨åˆå¿ƒè€…ï¼ˆTOEIC 300æœªæº€ï¼‰</option>
        <option value="A1">åˆå¿ƒè€…ï¼ˆTOEIC 300-500ï¼‰</option>
        <option value="A2">åˆä¸­ç´šï¼ˆTOEIC 500-650ï¼‰</option>
        <option value="B1">ä¸­ç´šï¼ˆTOEIC 650+ï¼‰</option>
      </select>
    </div>
    <div class="pill">
      ãƒ¢ãƒ¼ãƒ‰
      <div class="tabs" id="tabs"></div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card" id="left">
      <!-- content injected -->
    </section>

    <aside class="card">
      <div class="h2">å­¦ç¿’ç®¡ç†</div>
      <div class="muted">ã“ã®PCå†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸è¦ã€‚</div>
      <div class="divider"></div>

      <div class="kpi">
        <div class="k"><div class="v" id="k_today">0</div><div class="l">ä»Šæ—¥ã®å›æ•°</div></div>
        <div class="k"><div class="v" id="k_acc">0%</div><div class="l">æ­£ç­”ç‡ï¼ˆãƒ‰ãƒªãƒ«ï¼‰</div></div>
        <div class="k"><div class="v" id="k_streak">0</div><div class="l">é€£ç¶šæ—¥æ•°</div></div>
      </div>

      <div class="divider"></div>
      <div class="h3">è‹¦æ‰‹ã‚¿ã‚°ï¼ˆç›´è¿‘ï¼‰</div>
      <div class="chips" id="weakTags"></div>

      <div class="divider"></div>
      <div class="h3">å±¥æ­´ï¼ˆæœ€æ–°10ä»¶ï¼‰</div>
      <div class="muted" id="history"></div>

      <div class="divider"></div>
      <button class="ng" id="resetBtn">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <div class="muted small">â€»ã‚¢ãƒ—ãƒªãŒå£Šã‚ŒãŸã¨ãã ã‘ã€‚å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚åˆæœŸåŒ–ã€‚</div>
    </aside>
  </div>
</main>

<script>
/* =========================
   0) Storage / Utilities
========================= */
const APP_KEY = "eikaiwa_edge_v2";
const todayKey = () => new Date().toISOString().slice(0,10);
const LEVELS = ["A0","A1","A2","B1"]; // â˜…1å›ã ã‘ã«çµ±ä¸€

function loadState(){
  const raw = localStorage.getItem(APP_KEY);
  if(!raw){
    return {
      createdAt: Date.now(),
      streak: { lastDay:null, count:0 },
      stats: { drillTotal:0, drillCorrect:0 },
      today: { day: todayKey(), count:0 },
      weak: {}, // tag -> score
      history: [],
      custom: { drills: [] }
    };
  }
  try { return JSON.parse(raw); } catch { return null; }
}
function saveState(s){ localStorage.setItem(APP_KEY, JSON.stringify(s)); }

let STATE = loadState();
if(!STATE){
  localStorage.removeItem(APP_KEY);
  STATE = loadState();
}

function bumpToday(){
  const d = todayKey();
  if(STATE.today.day !== d){ STATE.today = {day:d,count:0}; }
  STATE.today.count++;
  const last = STATE.streak.lastDay;
  if(!last){
    STATE.streak = { lastDay:d, count:1 };
  }else{
    const lastDate = new Date(last);
    const now = new Date(d);
    const diffDays = Math.round((now - lastDate)/(1000*60*60*24));
    if(diffDays === 0){
    }else if(diffDays === 1){
      STATE.streak = { lastDay:d, count: STATE.streak.count + 1 };
    }else{
      STATE.streak = { lastDay:d, count:1 };
    }
  }
  saveState(STATE);
}

function addHistory(item){
  STATE.history.unshift({ t: Date.now(), ...item });
  STATE.history = STATE.history.slice(0,10);
  saveState(STATE);
}

function addWeak(tag, delta){
  if(!tag) return;
  if(!STATE.weak[tag]) STATE.weak[tag] = 0;
  STATE.weak[tag] += delta;
  STATE.weak[tag] = Math.max(-50, Math.min(50, STATE.weak[tag]));
  saveState(STATE);
}

function escapeHtml(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function normText(s){
  return (s||"")
    .toLowerCase()
    .replace(/[â€™']/g,"'")
    .replace(/[^a-z0-9\s']/g," ")
    .replace(/\s+/g," ")
    .trim();
}
function tokens(s){
  const t = normText(s);
  return t ? t.split(" ") : [];
}
function uniq(arr){
  return [...new Set(arr)];
}
function pct(n,d){ if(!d) return "0%"; return Math.round((n/d)*100)+"%"; }

/* =========================
   1) Japanese-learner feedback rules
========================= */
function japaneseWeaknessFeedback(expected, said){
  const exp = normText(expected);
  const got = normText(said);
  const expTok = tokens(exp);
  const gotTok = tokens(got);

  const expSet = new Map();
  expTok.forEach(w => expSet.set(w, (expSet.get(w)||0)+1));
  const gotSet = new Map();
  gotTok.forEach(w => gotSet.set(w, (gotSet.get(w)||0)+1));

  const missing = [];
  const extra = [];
  expSet.forEach((c,w)=>{
    const g = gotSet.get(w)||0;
    if(g < c) missing.push(w);
  });
  gotSet.forEach((c,w)=>{
    const e = expSet.get(w)||0;
    if(e < c) extra.push(w);
  });

  const tips = [];

  const hasArticle = expTok.some(w=>["a","an","the"].includes(w));
  if(hasArticle){
    const missArticle = ["a","an","the"].filter(a=>expTok.includes(a) && !gotTok.includes(a));
    if(missArticle.length){
      tips.push({ tag:"å† è©", text:`å† è©ï¼ˆa/an/theï¼‰ãŒæŠœã‘ã‚„ã™ã„ã§ã™ã€‚ä»Šå›ã¯ã€Œ${missArticle.join(", ")}ã€ãŒèã“ãˆã¾ã›ã‚“ã§ã—ãŸã€‚` });
    }
  }

  const preps = ["in","on","at","to","for","from","with","by","of","about","into","over","under","between","before","after"];
  const expPreps = preps.filter(p=>expTok.includes(p));
  const missPreps = expPreps.filter(p=>!gotTok.includes(p));
  if(missPreps.length){
    tips.push({ tag:"å‰ç½®è©", text:`å‰ç½®è©ãŒæŠœã‘ã‚„ã™ã„ã§ã™ã€‚ã€Œ${missPreps.join(", ")}ã€ã‚’æ„è­˜ã—ã¦ã€å‰ç½®è©ã‚’â€œçŸ­ãå¼±ãâ€å…¥ã‚Œã¦ã¿ã¦ãã ã•ã„ã€‚` });
  }

  const thirdPairs = [
    ["goes","go"],["does","do"],["has","have"],["likes","like"],["needs","need"],["wants","want"],["works","work"],["plays","play"]
  ];
  thirdPairs.forEach(([sForm, base])=>{
    if(expTok.includes(sForm) && gotTok.includes(base) && !gotTok.includes(sForm)){
      tips.push({ tag:"ä¸‰å˜ç¾", text:`ä¸‰å˜ç¾ã® -s ãŒè½ã¡ã‚„ã™ã„ã§ã™ã€‚ã€Œ${sForm}ã€ã‚’èªå°¾ã¾ã§ã—ã£ã‹ã‚Šã€‚` });
    }
  });

  const edPairs = [["worked","work"],["played","play"],["needed","need"],["wanted","want"],["called","call"],["asked","ask"],["helped","help"],["checked","check"]];
  edPairs.forEach(([ed, base])=>{
    if(expTok.includes(ed) && gotTok.includes(base) && !gotTok.includes(ed)){
      tips.push({ tag:"éå»å½¢", text:`éå»å½¢ -ed ãŒè½ã¡ã‚„ã™ã„ã§ã™ã€‚ã€Œ${ed}ã€ã‚’èªå°¾ã¾ã§ã€‚/t/ /d/ /Éªd/ ã®ã©ã‚Œã‹ã«ãªã‚Šã¾ã™ã€‚` });
    }
  });

  if(exp.includes("l") || exp.includes("r")){
    tips.push({ tag:"ç™ºéŸ³", text:`ç™ºéŸ³ã®ã‚³ãƒ„ï¼šRã¯èˆŒã‚’ã©ã“ã«ã‚‚ä»˜ã‘ãšå¥¥ã§ä¸¸ã‚ã‚‹ã€Lã¯èˆŒå…ˆã‚’ä¸Šã®æ­¯èŒã«â€œå½“ã¦ã‚‹â€ã€‚ï¼ˆèãåˆ†ã‘ã‚ˆã‚Šâ€œä½œã‚Šåˆ†ã‘â€ãŒå…ˆã§ã™ï¼‰` });
  }
  if(exp.includes("th")){
    tips.push({ tag:"ç™ºéŸ³", text:`THã®ã‚³ãƒ„ï¼šèˆŒå…ˆã‚’ä¸Šä¸‹ã®æ­¯ã®é–“ã«å°‘ã—å‡ºã—ã¦æ¯ã‚’æŠœãï¼ˆthinkï¼‰ã€‚æ¿ã‚‹ç‰ˆã¯ thisã€‚` });
  }

  const common = expTok.filter(w => gotSet.get(w));
  const score = expTok.length ? Math.round((common.length / expTok.length)*100) : 0;

  return { score, missing: uniq(missing), extra: uniq(extra), tips };
}

function highlightDiff(expected, said){
  const expTok = tokens(expected);
  const gotTok = tokens(said);

  const gotCount = new Map();
  gotTok.forEach(w=>gotCount.set(w,(gotCount.get(w)||0)+1));

  const marks = [];
  expTok.forEach(w=>{
    const c = gotCount.get(w)||0;
    if(c>0){
      marks.push({w, ok:true});
      gotCount.set(w,c-1);
    }else{
      marks.push({w, ok:false});
    }
  });

  const extra = [];
  gotCount.forEach((c,w)=>{ for(let i=0;i<c;i++) extra.push(w); });

  const expHtml = marks.map(m => m.ok ? `<span class="hl-ok">${escapeHtml(m.w)}</span>` : `<span class="hl-ng">${escapeHtml(m.w)}</span>`).join(" ");
  const extraHtml = extra.length ? extra.map(w=>`<span class="hl-ng">${escapeHtml(w)}</span>`).join(" ") : "(ãªã—)";
  return { expHtml, extraHtml };
}

/* =========================
   2) Talk content generator (NO "/")
   - 1 sentence per turn
   - ~300 scenes
========================= */
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function splitToPracticeSentences(text){
  const t = (text || "").trim();
  if(!t) return [];
  let parts = t
    .replace(/\s+/g," ")
    .split(/(?<=[\.\?\!])\s+/)
    .map(s=>s.trim())
    .filter(Boolean);

  const out = [];
  for(const p of parts){
    if(p.length <= 70){ out.push(p); continue; }
    const sub = p.split(/(?<=[,;:])\s+/).map(s=>s.trim()).filter(Boolean);
    out.push(...sub);
  }
  return out;
}

const CONV_SLOTS = {
  name: ["Sota","Yui","Haruto","Mina","Riku","Aoi","Kenta","Sara","Ren","Hana"],
  food: ["curry","ramen","pizza","sushi","pasta","fried chicken","salad","sandwich","rice ball","pancakes","ice cream"],
  drink: ["water","tea","milk","juice","coffee","sports drink","hot chocolate"],
  hobby: ["soccer","baseball","basketball","tennis","music","games","reading","drawing","cooking","dancing"],
  place: ["school","home","library","park","station","convenience store","shopping mall","cafe","gym","classroom"],
  day: ["today","tomorrow","this weekend","on Monday","on Tuesday","on Friday","on Saturday","next week"],
  time: ["after school","at 7 p.m.","in the morning","after dinner","at lunch","before class","after practice"],
  feeling: ["good","great","fine","tired","sleepy","hungry","excited","nervous","a bit sick"],
  weather: ["sunny","rainy","cloudy","windy","hot","cold","humid","snowy"],
  subject: ["math","English","science","PE","history","music","art","technology","Japanese"],
  // è¿½åŠ ã‚¹ãƒ­ãƒƒãƒˆï¼ˆä¼šè©±ã‚’ä¼¸ã°ã™ï¼‰
  activity: ["study","practice","hang out","go shopping","watch a movie","play games","do homework","clean my room"],
  reason: ["I have a test","I have practice","I'm busy","I'm free","I'm not feeling well","I promised my family"],
  transport: ["by train","by bus","on foot","by bike","by car"],
  minutes: ["5","10","15","20","30"],
  // åˆ†å²ï¼ˆ/ç¦æ­¢ãªã®ã§é…åˆ—ã§ï¼‰
  yn_do: ["Yes, I do.", "No, I don't."],
  yn_can: ["Yes, I can.", "No, I can't."],
  yn_are: ["Yes, I am.", "No, I'm not."],
  me_too: ["Me too.", "Me neither.", "I do too.", "I don't."],
  thanks: ["Thanks.", "Thank you.", "Thanks a lot.", "I appreciate it."],
  ok: ["OK.", "Sure.", "No problem.", "All right.", "Got it."],
  sorry: ["Sorry.", "I'm sorry.", "Sorry about that."],
};


function fillSlots(line){
  return (line || "")
    .replaceAll("{NAME}", pick(CONV_SLOTS.name))
    .replaceAll("{FOOD}", pick(CONV_SLOTS.food))
    .replaceAll("{DRINK}", pick(CONV_SLOTS.drink))
    .replaceAll("{HOBBY}", pick(CONV_SLOTS.hobby))
    .replaceAll("{PLACE}", pick(CONV_SLOTS.place))
    .replaceAll("{DAY}", pick(CONV_SLOTS.day))
    .replaceAll("{TIME}", pick(CONV_SLOTS.time))
    .replaceAll("{FEEL}", pick(CONV_SLOTS.feeling))
    .replaceAll("{WEATHER}", pick(CONV_SLOTS.weather))
    .replaceAll("{SUBJECT}", pick(CONV_SLOTS.subject))
    .replaceAll("{YN_DO}", pick(CONV_SLOTS.yn_do))
    .replaceAll("{ME_TOO}", pick(CONV_SLOTS.me_too))
    .replaceAll("{THANKS}", pick(CONV_SLOTS.thanks))
    .replaceAll("{OK}", pick(CONV_SLOTS.ok));
}

const CONV_TEMPLATES = [
  /* ======================
     A0ï¼ˆè¶…åŸºç¤ï¼šçŸ­ã‚â†’å°‘ã—é•·ã‚ï¼‰
  ====================== */
  {
    level:"A0", title:"ã‚ã„ã•ã¤ãƒ•ãƒ«", ja:"æŒ¨æ‹¶â†’åå‰â†’èª¿å­â†’ç· ã‚",
    lines:[
      "Hi, {NAME}!",
      "Hi!",
      "How are you?",
      "I'm {FEEL}.",
      "How about you?",
      "I'm {FEEL}, {THANKS}",
      "See you later.",
      "See you."
    ],
    tips:"æœ€åˆã¯â€œé€Ÿã•â€ã‚ˆã‚Šâ€œæ­¢ã¾ã‚‰ãªã„â€ãŒå‹ã¡ã€‚"
  },
  {
    level:"A0", title:"å¥½ãå«Œã„æ·±æ˜ã‚Š", ja:"å¥½ãâ†’ç†ç”±â†’ç›¸æ‰‹ã¸è¿”ã™",
    lines:[
      "Do you like {FOOD}?",
      "{YN_DO}",
      "Why?",
      "Because it's tasty.",
      "How about you?",
      "{YN_DO}",
      "{ME_TOO}"
    ],
    tips:"Do you likeâ€¦?â†’Yes/Noâ†’Becauseâ€¦ ã®3ç‚¹ã‚»ãƒƒãƒˆã€‚"
  },
  {
    level:"A0", title:"é£²ã¿ç‰©ã‚ªãƒ¼ãƒ€ãƒ¼", ja:"é£²ã¿ç‰©â†’ã‚µã‚¤ã‚ºâ†’ã‚ã‚ŠãŒã¨ã†",
    lines:[
      "Can I have {DRINK}, please?",
      "Sure.",
      "Small, please.",
      "{THANKS}",
      "You're welcome."
    ],
    tips:"please ã‚’æœ€å¾Œã«ç½®ãã¨ä¸å¯§ã€‚"
  },
  {
    level:"A0", title:"ä»Šã©ã“ï¼Ÿ", ja:"ä»Šã„ã‚‹å ´æ‰€â†’ä½•ã—ã¦ã‚‹",
    lines:[
      "Where are you?",
      "I'm at {PLACE}.",
      "What are you doing?",
      "I'm going to {activity}.",
      "OK."
    ],
    tips:"Where are you? / I'm atâ€¦ ã‚’ã‚»ãƒƒãƒˆã§ã€‚"
  },

  /* ======================
     A1ï¼ˆä¸­å­¦ç”Ÿã®æ—¥å¸¸ï¼š10ã€œ12ã‚¿ãƒ¼ãƒ³ä¸­å¿ƒï¼‰
  ====================== */
  {
    level:"A1", title:"æ”¾èª²å¾Œãƒ—ãƒ©ãƒ³èª¿æ•´", ja:"æ”¾èª²å¾Œâ†’èª˜ã„â†’æ™‚é–“â†’OK",
    lines:[
      "Hey, {NAME}.",
      "Hi!",
      "What are you doing {TIME}?",
      "I'm going to {activity}.",
      "Do you want to come with me?",
      "Maybe.",
      "What time?",
      "Let's meet {TIME}.",
      "Where?",
      "At the {PLACE}.",
      "Sounds good!",
      "See you then."
    ],
    tips:"What time? / Where? ãŒè¨€ãˆã‚‹ã¨ä¼šè©±ãŒä¼¸ã³ã‚‹ã€‚"
  },
  {
    level:"A1", title:"å®¿é¡Œãƒ˜ãƒ«ãƒ—", ja:"å›°ã‚Šã”ã¨â†’ãŠé¡˜ã„â†’ã‚ã‚ŠãŒã¨ã†",
    lines:[
      "Do you have homework?",
      "Yes, I do.",
      "It's hard.",
      "What's wrong?",
      "I don't understand this.",
      "Can you help me?",
      "Sure.",
      "How do you solve it?",
      "Like this.",
      "{THANKS}",
      "No problem."
    ],
    tips:"Can you help me? ãŒè¨€ãˆã‚‹ã¨åŠ©ã‘ã‚’å‘¼ã¹ã‚‹ã€‚"
  },
  {
    level:"A1", title:"éƒ¨æ´»ã‚ã‚‹ï¼Ÿ", ja:"éƒ¨æ´»â†’ä½•æ™‚ã¾ã§â†’å¿œæ´",
    lines:[
      "Do you have practice today?",
      "{YN_DO}",
      "What sport?",
      "I play {HOBBY}.",
      "When does it start?",
      "It starts {TIME}.",
      "When does it finish?",
      "It finishes at 6 p.m.",
      "Good luck!",
      "{THANKS}",
      "See you."
    ],
    tips:"When does it start/finish? ã®å‹ã‚’è¦šãˆã‚‹ã€‚"
  },
  {
    level:"A1", title:"ã‚³ãƒ³ãƒ“ãƒ‹è²·ã„ç‰©", ja:"ä½•è²·ã†â†’ãŠã™ã™ã‚â†’æ±ºã‚ã‚‹",
    lines:[
      "I'm going to the convenience store.",
      "What will you buy?",
      "Maybe {FOOD}.",
      "How about {FOOD}?",
      "Sounds good.",
      "Anything to drink?",
      "Yes, {DRINK}.",
      "Nice.",
      "{THANKS}",
      "Let's go."
    ],
    tips:"Maybe / How about ã‚’ä½¿ã†ã¨è‡ªç„¶ã€‚"
  },
  {
    level:"A1", title:"ä½“èª¿ã©ã†ï¼Ÿ", ja:"ä½“èª¿â†’å¿ƒé…â†’ææ¡ˆ",
    lines:[
      "You look tired.",
      "Yeah, I'm {FEEL}.",
      "Are you OK?",
      "Not really.",
      "Do you want to rest?",
      "Yes, please.",
      "Let's go to the nurse's office.",
      "OK.",
      "{THANKS}",
      "Take care."
    ],
    tips:"Are you OK? / Not really. ã¯ä¾¿åˆ©ã€‚"
  },
  {
    level:"A1", title:"æ˜ ç”»ã®è©±", ja:"è¦‹ãŸâ†’æ„Ÿæƒ³â†’ãŠã™ã™ã‚",
    lines:[
      "Did you watch a movie yesterday?",
      "Yes, I did.",
      "What movie?",
      "It was fun.",
      "Who did you watch it with?",
      "With my family.",
      "Do you recommend it?",
      "Yes, I do.",
      "I want to watch it.",
      "Let's go someday."
    ],
    tips:"Do you recommend it? ã‚’è¦šãˆã‚‹ã¨ä¼šè©±ãŒä¼¸ã³ã‚‹ã€‚"
  },

  /* ======================
     A2ï¼ˆäºˆå®šèª¿æ•´/ç†ç”±/ç§»å‹•/ä¸å¯§ï¼‰
  ====================== */
  {
    level:"A2", title:"é€±æœ«ã®ç´„æŸ", ja:"é€±æœ«â†’ç©ºãâ†’å ´æ‰€â†’äº¤é€šâ†’æ±ºã‚ã‚‹",
    lines:[
      "Are you free {DAY}?",
      "Maybe. Why?",
      "Let's go to the {PLACE}.",
      "Sounds good.",
      "What time should we meet?",
      "How about 10 a.m.?",
      "OK.",
      "How will you get there?",
      "I'll go {transport}.",
      "Me too.",
      "See you {DAY}.",
      "Don't be late!"
    ],
    tips:"How will you get there? ã¾ã§è¡Œãã¨â€œä¼šè©±æ„Ÿâ€ãŒå‡ºã‚‹ã€‚"
  },
  {
    level:"A2", title:"æ–­ã‚‹â†’ä»£æ¡ˆ", ja:"è¡Œã‘ãªã„â†’ç†ç”±â†’åˆ¥æ—¥",
    lines:[
      "Do you want to hang out {DAY}?",
      "I'd love to, but I can't.",
      "Why not?",
      "{reason}.",
      "Oh, I see.",
      "How about {DAY}?",
      "That works for me.",
      "Great.",
      "Where should we go?",
      "Let's decide later.",
      "OK, message me.",
      "Sure."
    ],
    tips:"I'd love to, butâ€¦ ã¯æ–­ã‚Šã®ç‹é“ã€‚"
  },
  {
    level:"A2", title:"å¿˜ã‚Œç‰©å¯¾å¿œ", ja:"å¿˜ã‚ŒãŸâ†’è²¸ã—ã¦â†’è¿”ã™ç´„æŸ",
    lines:[
      "Oh no. I forgot my notebook.",
      "Really?",
      "Can I borrow yours?",
      "Sure, but be careful.",
      "{THANKS}",
      "When will you return it?",
      "I'll return it tomorrow.",
      "OK.",
      "Don't forget.",
      "{OK}"
    ],
    tips:"borrow / return ã‚’ã‚»ãƒƒãƒˆã§è¦šãˆã‚‹ã€‚"
  },
  {
    level:"A2", title:"é“æ¡ˆå†…ï¼ˆä¸å¯§ï¼‰", ja:"é§…ã¾ã§â†’ã¾ã£ã™ãâ†’æ›²ãŒã‚‹â†’ç¢ºèª",
    lines:[
      "Excuse me. Where is the station?",
      "Go straight.",
      "Turn left at the corner.",
      "Is it far?",
      "No, it's about {minutes} minutes.",
      "{THANKS}",
      "You're welcome.",
      "Did you get it?",
      "Yes, I did.",
      "Have a nice day."
    ],
    tips:"Go straight / Turn left/right ã‚’å‹ã§ã€‚"
  },
  {
    level:"A2", title:"ãƒ†ã‚¹ãƒˆå‹‰å¼·è¨ˆç”»", ja:"ãƒ†ã‚¹ãƒˆâ†’ä¸€ç·’ã«å‹‰å¼·â†’æ™‚é–“â†’å†…å®¹",
    lines:[
      "Do you have a test soon?",
      "Yes, I do.",
      "What subject?",
      "{SUBJECT}.",
      "Do you want to study together?",
      "Sure.",
      "When are you free?",
      "I'm free {DAY}.",
      "Let's meet at the {PLACE}.",
      "What should we study first?",
      "Let's start with vocabulary.",
      "OK."
    ],
    tips:"When are you free? ãŒè¨€ãˆã‚‹ã¨äºˆå®šãŒçµ„ã‚ã‚‹ã€‚"
  },

  /* ======================
     B1ï¼ˆææ¡ˆ/æ„è¦‹/ç†ç”±/æ¡ä»¶/è»½ã„äº¤æ¸‰ï¼‰
  ====================== */
  {
    level:"B1", title:"ææ¡ˆâ†’ç†ç”±â†’åˆæ„", ja:"ææ¡ˆâ†’ç†ç”±â†’åˆæ„â†’æ®µå–ã‚Š",
    lines:[
      "Why don't we join the school event?",
      "I'm not sure.",
      "It could be fun.",
      "What do we need to do?",
      "We can help with planning.",
      "When is the meeting?",
      "It's {DAY} {TIME}.",
      "OK, I'll join.",
      "Great.",
      "Let's invite {NAME} too.",
      "Good idea.",
      "I'll message them."
    ],
    tips:"I'm not sure. â†’ ç†ç”±ã‚’è¶³ã—ã¦èª¬å¾—ã€ãŒB1ã®å…¥å£ã€‚"
  },
  {
    level:"B1", title:"ç›¸è«‡ï¼ˆè»½ã„æ‚©ã¿ï¼‰", ja:"æ‚©ã¿â†’åŠ©è¨€â†’æ„Ÿè¬",
    lines:[
      "Can I ask you something?",
      "Sure. What's up?",
      "I'm worried about {SUBJECT}.",
      "What part is difficult?",
      "I can't remember the rules.",
      "Why don't you make a small checklist?",
      "That sounds helpful.",
      "Also, practice for 10 minutes every day.",
      "OK, I'll try that.",
      "{THANKS}",
      "Anytime."
    ],
    tips:"Why don't youâ€¦ ã®â€œåŠ©è¨€â€ç”¨é€”ã€‚"
  },
  {
    level:"B1", title:"å¾…ã¡åˆã‚ã›èª¿æ•´ï¼ˆå¤‰æ›´ã‚ã‚Šï¼‰", ja:"é…ã‚Œã‚‹â†’è¬ã‚‹â†’å¤‰æ›´â†’ç¢ºèª",
    lines:[
      "Hey, I'm running late.",
      "How late?",
      "About {minutes} minutes.",
      "OK. Where are you now?",
      "I'm near the {PLACE}.",
      "No problem.",
      "{sorry}",
      "Let's meet at the entrance.",
      "Got it.",
      "Text me when you arrive.",
      "Sure.",
      "See you soon."
    ],
    tips:"I'm running late. / About 10 minutes. ã‚’è¨€ãˆã‚‹ã¨å¼·ã„ã€‚"
  },
];

/*
  â˜…è£œè¶³ï¼š
  - ã“ã“ã§ã¯ãƒ†ãƒ³ãƒ—ãƒ¬æ•°ã‚’å¢—ã‚„ã—ã¾ã—ãŸã€‚
  - ã•ã‚‰ã«å¢—ã‚„ã—ãŸã„å ´åˆã¯ã€ã“ã®é…åˆ—ã«åŒã˜å½¢å¼ã§è¿½åŠ ã—ã¦ã„ãã ã‘ã§OKã§ã™ã€‚
*/


function templatesUpTo(level){
  const idx = LEVELS.indexOf(level);
  return CONV_TEMPLATES.filter(t => LEVELS.indexOf(t.level) <= idx);
}

function buildConversationScenes(level, total=300){
  const tpls = templatesUpTo(level);
  const scenes = [];
  let id = 1;
  while(scenes.length < total){
    const tpl = pick(tpls);
    const filled = tpl.lines.map(line => fillSlots(line));
    const turns = [];
    for(const line of filled) turns.push(...splitToPracticeSentences(line));
    scenes.push({
      id: `cv_${level}_${id++}`,
      level,
      title: tpl.title,
      ja: tpl.ja,
      tips: tpl.tips,
      type: "conv",
      turns,
      turnIndex: 0,
      en: turns[0] || ""
    });
  }
  return scenes;
}

function convAdvance(scene){
  if(!scene || scene.type !== "conv" || !Array.isArray(scene.turns)) return;
  scene.turnIndex = (scene.turnIndex ?? 0) + 1;
  if(scene.turnIndex >= scene.turns.length) scene.turnIndex = 0;
  scene.en = scene.turns[scene.turnIndex] || "";
}
function convNormalizeEn(scene){
  if(!scene || scene.type !== "conv") return;
  if(typeof scene.en !== "string") scene.en = "";
  if(scene.en.includes("/")){
    const alts = scene.en.split("/").map(s=>s.trim()).filter(Boolean);
    scene.en = alts.length ? pick(alts) : scene.en.replaceAll("/"," ");
  }
  const one = splitToPracticeSentences(scene.en)[0];
  if(one) scene.en = one;
}

/* =========================
   2b) Drills
========================= */
function drillsCommonByLevel(level){
  const base = [
    {id:"c_a_1", level:"A0", type:"mcq", tag:"å† è©", q:"I have ___ apple.", a:"an", c:["a","an","the","(no article)"], explain:"æ¯éŸ³ï¼ˆa,e,i,o,uï¼‰ã§å§‹ã¾ã‚‹å˜èªã®å‰ã¯ an ãŒåŸºæœ¬ã€‚"},
    {id:"c_p_1", level:"A0", type:"mcq", tag:"å‰ç½®è©", q:"I'm ___ Tokyo.", a:"in", c:["in","on","at","to"], explain:"éƒ½å¸‚ãƒ»å›½ãªã©â€œç¯„å›²â€ã¯ inã€‚"},
    {id:"c_p_2", level:"A1", type:"mcq", tag:"å‰ç½®è©", q:"Let's meet ___ 3 p.m.", a:"at", c:["in","on","at","to"], explain:"æ™‚åˆ»ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã¯ atã€‚"},
    {id:"c_3s_1", level:"A1", type:"mcq", tag:"ä¸‰å˜ç¾", q:"He ___ to work every day.", a:"goes", c:["go","goes","going","went"], explain:"He/She/It ã®ç¾åœ¨å½¢ã¯å‹•è©ã« -s / -esã€‚"},
    {id:"c_ed_1", level:"A1", type:"mcq", tag:"éå»å½¢", q:"I ___ you yesterday.", a:"called", c:["call","called","calling","calls"], explain:"éå»ã®å‡ºæ¥äº‹ã¯éå»å½¢ã€‚"},
    {id:"c_a_2", level:"A2", type:"mcq", tag:"å† è©", q:"Can you pass me ___ salt?", a:"the", c:["a","an","the","(no article)"], explain:"ä¼šè©±ã®å ´ã§â€œãã®å¡©â€ã¨ç‰¹å®šã§ãã‚‹ã¨ theã€‚"},
    {id:"c_p_3", level:"A2", type:"mcq", tag:"å‰ç½®è©", q:"I'm looking ___ my keys.", a:"for", c:["for","at","to","about"], explain:"look for = æ¢ã™ã€‚"},
    {id:"c_3s_2", level:"A2", type:"mcq", tag:"ä¸‰å˜ç¾", q:"She ___ a car.", a:"has", c:["have","has","having","had"], explain:"have ã®ä¸‰å˜ç¾ã¯ hasã€‚"},
    {id:"c_ed_2", level:"B1", type:"mcq", tag:"éå»å½¢", q:"We ___ the report by noon.", a:"finished", c:["finish","finished","finishing","finishes"], explain:"by + æ™‚åˆ» ã®å‰ã«å®Œäº†ã—ãŸã€ã‚’ç¤ºã™ãªã‚‰éå»å½¢ãŒè‡ªç„¶ã€‚"}
  ];
  const idx = LEVELS.indexOf(level);
  return base.filter(d => LEVELS.indexOf(d.level) <= idx);
}

const DRILLS_EIKEN = [
  {id:"e1", level:"A1", type:"reorder", tag:"è‹±æ¤œ_èªé †", q:"ï¼ˆä¸¦ã¹æ›¿ãˆï¼‰ã€Œç§ã¯ã‚ãªãŸã‚’æ‰‹ä¼ãˆã¾ã™ã€‚ã€", words:["can","I","help","you"], a:"I can help you", explain:"åŠ©å‹•è© can ã¯ä¸»èªã®å¾Œã€‚"},
  {id:"e2", level:"A2", type:"reorder", tag:"è‹±æ¤œ_èªé †", q:"ï¼ˆä¸¦ã¹æ›¿ãˆï¼‰ã€Œå½¼ã¯æ˜¨æ—¥å­¦æ ¡ã¸è¡Œãã¾ã—ãŸã€‚ã€", words:["went","to","school","he","yesterday"], a:"He went to school yesterday", explain:"åŸºæœ¬ï¼šä¸»èªâ†’å‹•è©â†’ç›®çš„èªâ†’æ™‚é–“ã€‚"},
  {id:"e3", level:"A2", type:"mcq", tag:"è‹±æ¤œ_ç©´åŸ‹ã‚", q:"She is good ___ math.", a:"at", c:["in","on","at","to"], explain:"be good at ã€œ ãŒå‹ã€‚"},
  {id:"e4", level:"B1", type:"mcq", tag:"è‹±æ¤œ_ç©´åŸ‹ã‚", q:"If it ___ tomorrow, we'll stay home.", a:"rains", c:["rain","rains","rained","raining"], explain:"ifç¯€ã®ç¾åœ¨å½¢ï¼ˆæœªæ¥ã§ã‚‚ç¾åœ¨å½¢ï¼‰ã€‚"}
];

const DRILLS_TOEIC = [
  {id:"t1", level:"A1", type:"mcq", tag:"TOEIC_P5", q:"The manager will ___ the schedule tomorrow.", a:"review", c:["review","reviews","reviewed","reviewing"], explain:"will ã®å¾Œã¯å‹•è©ã®åŸå½¢ã€‚"},
  {id:"t2", level:"A2", type:"mcq", tag:"TOEIC_P5", q:"Please submit the form ___ Friday.", a:"by", c:["by","in","on","at"], explain:"ç· åˆ‡ã¯ byã€‚"},
  {id:"t3", level:"A2", type:"mcq", tag:"TOEIC_P5", q:"We are ___ to announce the new product.", a:"pleased", c:["please","pleased","pleasing","pleasure"], explain:"be pleased to ã€œï¼ˆå½¢å®¹è©ï¼‰ã€‚"},
  {id:"t4", level:"B1", type:"mcq", tag:"TOEIC_P5", q:"The meeting was postponed ___ a technical issue.", a:"due to", c:["because","due to","since","so"], explain:"due to + åè©ã€‚because/since ã¯ç¯€ã€‚"}
];

/* =========================
   3) Web Speech (TTS + STT)
========================= */
function speak(text){
  if(!("speechSynthesis" in window)){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function createRecognizer(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = "en-US";
  r.interimResults = false;
  r.maxAlternatives = 1;
  return r;
}

/* =========================
   4) UI: Tabs + Render
========================= */
const TABS = [
  { key:"talk", label:"ä¼šè©±ç·´ç¿’" },
  { key:"common", label:"å…±é€šãƒ‰ãƒªãƒ«" },
  { key:"eiken", label:"è‹±æ¤œ" },
  { key:"toeic", label:"TOEIC P5" },
  { key:"custom", label:"ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œ" }
];

let ACTIVE = "talk";
let CURRENT = { drill:null, scene:null, talkPool:null };

const elTabs = document.getElementById("tabs");
const elLeft = document.getElementById("left");
const elLevel = document.getElementById("levelSel");

const savedLevel = localStorage.getItem(APP_KEY+"_level");
if(savedLevel && LEVELS.includes(savedLevel)) elLevel.value = savedLevel;

function renderTabs(){
  elTabs.innerHTML = "";
  TABS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab" + (t.key===ACTIVE ? " active": "");
    b.textContent = t.label;
    b.onclick = ()=>{ ACTIVE=t.key; renderTabs(); renderLeft(); };
    elTabs.appendChild(b);
  });
}

function renderStats(){
  const d = todayKey();
  if(STATE.today.day !== d){ STATE.today = {day:d,count:0}; saveState(STATE); }
  document.getElementById("k_today").textContent = STATE.today.count;
  document.getElementById("k_acc").textContent = pct(STATE.stats.drillCorrect, STATE.stats.drillTotal);
  document.getElementById("k_streak").textContent = STATE.streak.count;

  const entries = Object.entries(STATE.weak)
    .sort((a,b)=> a[1]-b[1])
    .slice(0,8);

  const wrap = document.getElementById("weakTags");
  wrap.innerHTML = entries.length ? "" : `<span class="muted">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</span>`;
  entries.forEach(([tag,score])=>{
    const s = document.createElement("span");
    s.className = "chip";
    s.textContent = `${tag}ï¼ˆ${score<=0 ? "å¼±" : "ä¼¸"}ï¼‰`;
    wrap.appendChild(s);
  });

  const h = document.getElementById("history");
  if(!STATE.history.length){
    h.innerHTML = `<span class="muted">ã¾ã ã‚ã‚Šã¾ã›ã‚“</span>`;
  }else{
    h.innerHTML = STATE.history.map(x=>{
      const t = new Date(x.t).toLocaleString();
      const res = x.ok==null ? "" : (x.ok ? "âœ…" : "âŒ");
      return `<div class="small">â€¢ ${escapeHtml(t)} ${res} ${escapeHtml(x.title||x.type||"")}</div>`;
    }).join("");
  }
}

function levelFilter(items){
  const lv = elLevel.value;
  const idx = LEVELS.indexOf(lv);
  return items.filter(it => LEVELS.indexOf(it.level) <= idx);
}

/* =========================
   5) Talk (no SCENES, generate pool)
========================= */
function getTalkPool(){
  const lv = elLevel.value;
  // ãƒ¬ãƒ™ãƒ«ã§ç”Ÿæˆã€‚æ¯å›ç”Ÿæˆã™ã‚‹ã¨é‡ã„ã®ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  if(!CURRENT.talkPool || CURRENT.talkPoolLevel !== lv){
    CURRENT.talkPool = buildConversationScenes(lv, 300);
    CURRENT.talkPoolLevel = lv;
  }
  return CURRENT.talkPool;
}

function pickScene(){
  const pool = getTalkPool();
  return pool[Math.floor(Math.random()*pool.length)];
}

function renderTalk(){
  const scene = CURRENT.scene || pickScene();
  CURRENT.scene = scene;
  convNormalizeEn(scene); // å¿µã®ãŸã‚ 1æ–‡åŒ–

  elLeft.innerHTML = `
    <div class="h2">ä¼šè©±ç·´ç¿’ï¼ˆãŠæ‰‹æœ¬ â†’ éŒ²éŸ³ â†’ å·®åˆ† â†’ æ—¥æœ¬èªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰</div>
    <div class="muted">ä¼šè©±ã¯ã€Œ1æ–‡ãšã¤ã€ç·´ç¿’ã€‚éŒ²éŸ³ã—ã¦åˆ¤å®šã™ã‚‹ã¨è‡ªå‹•ã§æ¬¡ã®æ–‡ã«é€²ã¿ã¾ã™ã€‚</div>
    <div class="divider"></div>

    <div class="qbox">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="h3">${escapeHtml(scene.title)} <span class="chip">${scene.level}</span></div>
          <div class="muted">æ—¥æœ¬èªï¼š${escapeHtml(scene.ja)}</div>
        </div>
        <button class="primary" id="nextScene">åˆ¥ã‚·ãƒ¼ãƒ³</button>
      </div>
      <div class="divider"></div>

      <div class="h3">ãŠæ‰‹æœ¬ï¼ˆè‹±èªï¼š1æ–‡ï¼‰</div>
      <div style="font-size:18px;font-weight:800">${escapeHtml(scene.en)}</div>
      <div class="muted">${escapeHtml(scene.tips||"")}</div>

      <div class="divider"></div>
      <div class="row">
        <button class="primary" id="btnSpeak">ğŸ”Š ãŠæ‰‹æœ¬ã‚’èã</button>
        <button class="ok" id="btnRec">ğŸ™ï¸ éŒ²éŸ³ã—ã¦åˆ¤å®šï¼ˆæ¬¡ã®æ–‡ã¸ï¼‰</button>
      </div>

      <div class="divider"></div>
      <div class="h3">çµæœ</div>
      <div class="muted small">ç·‘=ä¸€è‡´ / èµ¤=ä¸è¶³ï¼ˆæœŸå¾…ã—ãŸã®ã«èã“ãˆãªã„ï¼‰</div>
      <div id="diffExp" class="mono" style="margin-top:6px"></div>
      <div class="muted small" style="margin-top:10px">ä½™åˆ†ã«èã“ãˆãŸèªï¼ˆèµ¤ï¼‰</div>
      <div id="diffExtra" class="mono" style="margin-top:6px"></div>

      <div class="divider"></div>
      <div class="h3">æ—¥æœ¬èªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
      <div id="fb" class="muted"></div>

      <div class="divider"></div>
      <div class="muted small">é€²æ—ï¼š<b>${(scene.turnIndex||0)+1}</b> / ${scene.turns?.length||1} æ–‡</div>
    </div>
  `;

  document.getElementById("nextScene").onclick = ()=>{
    CURRENT.scene = pickScene();
    renderTalk();
  };
  document.getElementById("btnSpeak").onclick = ()=> speak(scene.en);

  document.getElementById("btnRec").onclick = async ()=>{
    const rec = createRecognizer();
    if(!rec){
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }
    bumpToday();
    renderStats();

    const btn = document.getElementById("btnRec");
    btn.disabled = true;
    btn.textContent = "ğŸ™ï¸ èãå–ã‚Šä¸­...";

    rec.onresult = (e)=>{
      const said = e.results?.[0]?.[0]?.transcript || "";
      const { expHtml, extraHtml } = highlightDiff(scene.en, said);
      document.getElementById("diffExp").innerHTML = expHtml || "(èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ)";
      document.getElementById("diffExtra").innerHTML = extraHtml;

      const fb = japaneseWeaknessFeedback(scene.en, said);
      const lines = [];
      lines.push(`ä¸€è‡´åº¦ï¼ˆç›®å®‰ï¼‰ï¼š<b>${fb.score}%</b>`);
      if(fb.missing.length) lines.push(`ä¸è¶³ã—ãŒã¡ãªèªï¼š<b>${fb.missing.join(", ")}</b>`);
      if(fb.extra.length) lines.push(`ä½™åˆ†ã«èã“ãˆãŸèªï¼š<b>${fb.extra.join(", ")}</b>`);
      if(!fb.missing.length && !fb.extra.length) lines.push("ã‹ãªã‚Šè¿‘ã„ã§ã™ã€‚æ¬¡ã¯ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å°‘ã—ä¸Šã’ã¦â€œã¤ãªãŒã‚Šâ€ã‚’æ„è­˜ã€‚");

      if(fb.tips.length){
        lines.push("<br><b>æ—¥æœ¬äººå‘ã‘ã®æŒ‡æ‘˜ï¼š</b>");
        fb.tips.forEach(t=>{
          lines.push(`â€¢ ${escapeHtml(t.text)}`);
          if(t.tag) addWeak(t.tag, -2);
        });
      }
      document.getElementById("fb").innerHTML = lines.join("<br>");

      addHistory({ type:"talk", title:`ä¼šè©±:${scene.title}`, ok:null });
      saveState(STATE);
      renderStats();

      // â˜…ã“ã“ãŒã€Œ3ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€å•é¡Œã®è§£æ±ºï¼šçµæœã®å¾Œã«è‡ªå‹•ã§æ¬¡ã®1æ–‡ã¸
      convAdvance(scene);
      convNormalizeEn(scene);
      renderTalk();
    };

    rec.onerror = ()=>{
      btn.disabled = false;
      btn.textContent = "ğŸ™ï¸ éŒ²éŸ³ã—ã¦åˆ¤å®šï¼ˆæ¬¡ã®æ–‡ã¸ï¼‰";
      document.getElementById("fb").innerHTML = "éŸ³å£°èªè­˜ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸã€‚Edgeã®ğŸ”’ã‹ã‚‰ãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    };

    rec.onend = ()=>{
      btn.disabled = false;
      btn.textContent = "ğŸ™ï¸ éŒ²éŸ³ã—ã¦åˆ¤å®šï¼ˆæ¬¡ã®æ–‡ã¸ï¼‰";
    };

    try { rec.start(); } catch { btn.disabled=false; btn.textContent="ğŸ™ï¸ éŒ²éŸ³ã—ã¦åˆ¤å®šï¼ˆæ¬¡ã®æ–‡ã¸ï¼‰"; }
  };
}

/* =========================
   6) Drills (MCQ / Reorder)
========================= */
function pickDrill(mode){
  const lv = elLevel.value;
  let pool = [];
  if(mode==="common") pool = drillsCommonByLevel(lv);
  if(mode==="eiken") pool = levelFilter(DRILLS_EIKEN);
  if(mode==="toeic") pool = levelFilter(DRILLS_TOEIC);
  if(mode==="custom"){
    pool = (STATE.custom?.drills || []).filter(d=>{
      if(!d.level) return true;
      return LEVELS.indexOf(d.level) <= LEVELS.indexOf(lv);
    });
  }
  if(!pool.length) return null;
  return pool[Math.floor(Math.random()*pool.length)];
}

function markAnswer(ok, drill){
  bumpToday();
  if(drill && drill.type){
    STATE.stats.drillTotal++;
    if(ok) STATE.stats.drillCorrect++;
    addWeak(drill.tag, ok ? +1 : -3);
    addHistory({ type: drill.tag || drill.type, title: drill.id, ok });
    saveState(STATE);
  }
  renderStats();
}

function renderMCQ(drill, modeTitle){
  elLeft.innerHTML = `
    <div class="h2">${escapeHtml(modeTitle)}</div>
    <div class="muted">1å•20ã€œ40ç§’ã§å›ã™è¨­è¨ˆã€‚æ—¥æœ¬èªè§£èª¬ã¤ãã€‚</div>
    <div class="divider"></div>

    <div class="qbox">
      <div class="row" style="justify-content:space-between">
        <div class="chips">
          <span class="chip">${escapeHtml(drill.level||"")}</span>
          <span class="chip">${escapeHtml(drill.tag||"")}</span>
        </div>
        <button class="primary" id="nextQ">æ¬¡ã®å•é¡Œ</button>
      </div>

      <div class="divider"></div>
      <div style="font-size:18px;font-weight:800">${escapeHtml(drill.q)}</div>

      <div class="choices" id="choices"></div>

      <div class="divider"></div>
      <div class="h3">è§£èª¬ï¼ˆæ—¥æœ¬èªï¼‰</div>
      <div class="muted" id="exp">(å›ç­”å¾Œã«è¡¨ç¤º)</div>
    </div>
  `;

  const choices = document.getElementById("choices");
  drill.c.forEach(ch=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.textContent = ch;
    div.onclick = ()=>{
      [...choices.children].forEach(x=>x.onclick=null);

      const ok = (ch === drill.a);
      div.classList.add(ok ? "correct" : "wrong");
      [...choices.children].forEach(x=>{
        if(x.textContent === drill.a) x.classList.add("correct");
      });
      document.getElementById("exp").textContent = drill.explain || "";
      markAnswer(ok, drill);
    };
    choices.appendChild(div);
  });

  document.getElementById("nextQ").onclick = ()=>{
    CURRENT.drill = pickDrill(ACTIVE);
    renderLeft();
  };
}

function renderReorder(drill, modeTitle){
  elLeft.innerHTML = `
    <div class="h2">${escapeHtml(modeTitle)}</div>
    <div class="muted">èªé †ï¼ˆä¸¦ã¹æ›¿ãˆï¼‰ã€‚å‹ã§çŸ¯æ­£ã—ã¾ã™ã€‚</div>
    <div class="divider"></div>

    <div class="qbox">
      <div class="row" style="justify-content:space-between">
        <div class="chips">
          <span class="chip">${escapeHtml(drill.level||"")}</span>
          <span class="chip">${escapeHtml(drill.tag||"")}</span>
        </div>
        <button class="primary" id="nextQ">æ¬¡ã®å•é¡Œ</button>
      </div>

      <div class="divider"></div>
      <div style="font-size:18px;font-weight:800">${escapeHtml(drill.q)}</div>

      <div class="divider"></div>
      <div class="h3">å˜èªã‚’é †ã«ã‚¯ãƒªãƒƒã‚¯</div>
      <div class="chips" id="wordBank"></div>

      <div class="divider"></div>
      <div class="h3">ã‚ãªãŸã®å›ç­”</div>
      <div class="qbox mono" id="ansBox"></div>

      <div class="row" style="margin-top:10px">
        <button class="ok" id="checkBtn">åˆ¤å®š</button>
        <button id="clearBtn">ã‚„ã‚Šç›´ã—</button>
        <button class="primary" id="speakBtn">ğŸ”Š æ­£è§£ã‚’èã</button>
      </div>

      <div class="divider"></div>
      <div class="h3">è§£èª¬ï¼ˆæ—¥æœ¬èªï¼‰</div>
      <div class="muted" id="exp">(åˆ¤å®šå¾Œã«è¡¨ç¤º)</div>
    </div>
  `;

  const bank = document.getElementById("wordBank");
  const ansBox = document.getElementById("ansBox");
  let selected = [];

  const words = drill.words.slice().sort(()=>Math.random()-0.5);
  words.forEach(w=>{
    const b = document.createElement("button");
    b.textContent = w;
    b.onclick = ()=>{
      selected.push(w);
      b.disabled = true;
      ansBox.textContent = selected.join(" ");
    };
    bank.appendChild(b);
  });

  document.getElementById("clearBtn").onclick = ()=>{
    selected = [];
    ansBox.textContent = "";
    [...bank.querySelectorAll("button")].forEach(b=>b.disabled=false);
    document.getElementById("exp").textContent = "(åˆ¤å®šå¾Œã«è¡¨ç¤º)";
  };

  document.getElementById("speakBtn").onclick = ()=> speak(drill.a);

  document.getElementById("checkBtn").onclick = ()=>{
    const user = selected.join(" ");
    const ok = normText(user) === normText(drill.a);
    ansBox.innerHTML = ok
      ? `<span class="hl-ok">${escapeHtml(user || "(ç©º)")}</span>`
      : `<span class="hl-ng">${escapeHtml(user || "(ç©º)")}</span>`;
    document.getElementById("exp").textContent = drill.explain || "";
    markAnswer(ok, drill);
  };

  document.getElementById("nextQ").onclick = ()=>{
    CURRENT.drill = pickDrill(ACTIVE);
    renderLeft();
  };
}

function renderDrill(mode){
  const titles = {
    common:"å…±é€šãƒ‰ãƒªãƒ«ï¼ˆå† è©/å‰ç½®è©/ä¸‰å˜ç¾/éå»å½¢ï¼‰",
    eiken:"è‹±æ¤œï¼ˆç©´åŸ‹ã‚ï¼‹ä¸¦ã¹æ›¿ãˆï¼‰",
    toeic:"TOEIC Part5ï¼ˆç©´åŸ‹ã‚ï¼‰",
    custom:"ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œï¼ˆã‚ãªãŸãŒè¿½åŠ ï¼‰"
  };
  const d = CURRENT.drill || pickDrill(mode);
  CURRENT.drill = d;

  if(!d){
    elLeft.innerHTML = `
      <div class="h2">${escapeHtml(titles[mode])}</div>
      <div class="muted">ã“ã®ãƒ¬ãƒ™ãƒ«ã§å‡ºã›ã‚‹å•é¡ŒãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      <div class="divider"></div>
      <div class="muted">â†’ ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œã«è¿½åŠ ã™ã‚‹ã‹ã€ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã¦ã¿ã¦ãã ã•ã„ã€‚</div>
    `;
    return;
  }
  if(d.type==="mcq") renderMCQ(d, titles[mode]);
  else if(d.type==="reorder") renderReorder(d, titles[mode]);
  else renderMCQ(d, titles[mode]);
}

/* =========================
   7) Custom Problems UI
========================= */
function renderCustom(){
  renderDrill("custom");

  const editor = document.createElement("div");
  editor.className = "divider";
  elLeft.appendChild(editor);

  const box = document.createElement("div");
  box.className = "qbox";
  box.innerHTML = `
    <div class="h3">ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œã®è¿½åŠ ï¼ˆJSONï¼‰</div>
    <div class="muted small">
      å½¢å¼ï¼š<b>MCQ</b>ï¼ˆç©´åŸ‹ã‚ï¼‰ã¾ãŸã¯ <b>reorder</b>ï¼ˆä¸¦ã¹æ›¿ãˆï¼‰ã€‚<br>
      ä¿å­˜ã™ã‚‹ã¨ã“ã®PCå†…ã«æ®‹ã‚Šã¾ã™ï¼ˆç„¡æ–™ï¼‰ã€‚<br>
      â€»ä¾‹ã¯ä¸‹ã«å…¥ã‚Œã¦ã‚ã‚Šã¾ã™ã€‚ãã®ã¾ã¾è¿½åŠ ã—ã¦OKã€‚
    </div>
    <div class="divider"></div>
    <textarea id="customJson" class="mono"></textarea>
    <div class="row" style="margin-top:10px">
      <button class="ok" id="addCustomBtn">è¿½åŠ ã—ã¦ä¿å­˜</button>
      <button id="exportBtn">ã„ã¾ã®å•é¡Œã‚’è¡¨ç¤ºï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰</button>
    </div>
    <div class="muted small" id="customMsg" style="margin-top:8px"></div>
  `;
  elLeft.appendChild(box);

  const example = [
    {id:"u1", level:"A0", type:"mcq", tag:"å† è©", q:"I bought ___ umbrella.", a:"an", c:["a","an","the","(no article)"], explain:"æ¯éŸ³ã§å§‹ã¾ã‚‹ã®ã§ anã€‚"},
    {id:"u2", level:"A1", type:"reorder", tag:"èªé †", q:"ï¼ˆä¸¦ã¹æ›¿ãˆï¼‰ã€Œå½¼å¥³ã¯æ¯æ—¥èµ°ã‚Šã¾ã™ã€‚ã€", words:["runs","she","every","day"], a:"She runs every day", explain:"ä¸»èªâ†’å‹•è©â†’å‰¯è©å¥ã€‚"}
  ];
  document.getElementById("customJson").value = JSON.stringify(example, null, 2);

  document.getElementById("addCustomBtn").onclick = ()=>{
    const msg = document.getElementById("customMsg");
    msg.textContent = "";
    try{
      const arr = JSON.parse(document.getElementById("customJson").value);
      if(!Array.isArray(arr)) throw new Error("JSONã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");

      arr.forEach((d,i)=>{
        if(!d.id) d.id = `user_${Date.now()}_${i}`;
        if(!d.type) throw new Error("type ãŒå¿…è¦ï¼ˆmcq / reorderï¼‰");
        if(d.type==="mcq"){
          if(!d.q || !d.a || !Array.isArray(d.c)) throw new Error("mcqã¯ q/a/c ãŒå¿…è¦");
        }
        if(d.type==="reorder"){
          if(!d.q || !d.a || !Array.isArray(d.words)) throw new Error("reorderã¯ q/a/words ãŒå¿…è¦");
        }
        if(!d.level) d.level = "A0";
        if(!d.tag) d.tag = "custom";
      });

      STATE.custom.drills = (STATE.custom.drills || []).concat(arr);
      saveState(STATE);
      msg.textContent = `è¿½åŠ ã—ã¾ã—ãŸï¼ˆåˆè¨ˆ ${STATE.custom.drills.length} å•ï¼‰ã€‚`;
      renderStats();
      CURRENT.drill = pickDrill("custom");
    }catch(e){
      msg.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + (e?.message || e);
    }
  };

  document.getElementById("exportBtn").onclick = ()=>{
    const msg = document.getElementById("customMsg");
    document.getElementById("customJson").value = JSON.stringify(STATE.custom.drills || [], null, 2);
    msg.textContent = "ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚";
  };
}

/* =========================
   8) Main render switch
========================= */
function renderLeft(){
  if(ACTIVE==="talk") renderTalk();
  else if(ACTIVE==="common") renderDrill("common");
  else if(ACTIVE==="eiken") renderDrill("eiken");
  else if(ACTIVE==="toeic") renderDrill("toeic");
  else if(ACTIVE==="custom") renderCustom();
  else renderTalk();
}

renderTabs();
renderLeft();
renderStats();

elLevel.onchange = ()=>{
  localStorage.setItem(APP_KEY+"_level", elLevel.value);
  CURRENT = { drill:null, scene:null, talkPool:null };
  renderLeft();
};

document.getElementById("resetBtn").onclick = ()=>{
  if(confirm("å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
    localStorage.removeItem(APP_KEY);
    localStorage.removeItem(APP_KEY+"_level");
    location.reload();
  }
};
</script>
</body>
</html>
